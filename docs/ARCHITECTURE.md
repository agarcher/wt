# Architecture

This document describes the internal architecture of `wt` for developers who want to understand or contribute to the codebase.

## Overview

`wt` is a Git worktree manager CLI built with Go and Cobra. It follows a shell wrapper pattern similar to tools like direnv, zoxide, and starship.

```
┌─────────────────────────────────────────────────────────────┐
│                        User Shell                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Shell Function (from `wt init zsh`)                │   │
│  │  - Wraps binary calls                               │   │
│  │  - Handles `cd` based on binary output              │   │
│  │  - Passes through to PATH when not in wt repo       │   │
│  └──────────────────────┬──────────────────────────────┘   │
└─────────────────────────┼───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                     Go Binary (`wt`)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Commands  │  │   Config    │  │   Hook Executor     │ │
│  │  - create   │  │  - .wt.yaml │  │  - pre_create       │ │
│  │  - delete   │  │  - global   │  │  - post_create      │ │
│  │  - list     │  │             │  │  - pre_delete       │ │
│  │  - cd       │  │             │  │  - post_delete      │ │
│  │  - init     │  │             │  │  - pre_cleanup      │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Package Structure

```
wt/
├── cmd/wt/main.go        # Entry point, delegates to commands.Execute()
├── internal/
│   ├── commands/         # Cobra command implementations
│   ├── config/           # .wt.yaml configuration loading and parsing
│   ├── git/              # Git worktree operations wrapper
│   ├── hooks/            # Lifecycle hook execution engine
│   └── shell/            # Shell integration generators (zsh/bash/fish)
├── examples/hooks/       # Example hook scripts for common use cases
└── scripts/completions/  # Shell completions
```

## Key Design Patterns

### Shell Integration

**The problem:** Subprocesses cannot change the parent shell's working directory.

**The solution:** The binary outputs a path on its last line, and a shell wrapper function (generated by `wt init <shell>`) reads this output and executes `cd`.

**Precedent:** This pattern is used by direnv, zoxide, starship, and other shell-integrated tools.

### Repository Detection

The tool determines whether it's running in the main repo or a worktree by checking if `.git` is a file (worktree) or directory (main repo). Git worktrees store their `.git` as a file containing a gitdir reference.

### Hook Environment

All hooks receive standardized environment variables:
- `WT_NAME` - worktree name
- `WT_PATH` - full path to worktree
- `WT_BRANCH` - git branch name
- `WT_REPO_ROOT` - main repository root
- `WT_WORKTREE_DIR` - worktree directory name (e.g., "worktrees")

### Version Injection

Version is set at build time via ldflags:
```
-X github.com/agarcher/wt/internal/commands.Version=$(VERSION)
```

### Output Conventions

- `cmd.Println()` writes to stderr (for messages/errors)
- `fmt.Fprintln(cmd.OutOrStdout(), ...)` writes to stdout (for paths, listings)

This separation is important because the shell wrapper parses stdout to extract paths for `cd` commands.

## Configuration

The tool is configured per-repository via `.wt.yaml` in the repository root:

```yaml
version: 1
worktree_dir: worktrees
branch_pattern: "{name}"

hooks:
  pre_create:
    - script: ./scripts/pre-create.sh
  post_create:
    - script: ./scripts/post-create.sh
      env:
        CUSTOM_VAR: "value"
  pre_delete:
    - script: ./scripts/pre-delete.sh
  post_delete:
    - script: ./scripts/post-delete.sh
```

### Why repo-local config?

- Each repo can have different needs (port schemes, custom hooks)
- No namespace pollution when not in a configured repo
- Teams can version control their `.wt.yaml`

## Design Decisions

### Why Go?

- Faster development cycle for CLI tools
- Excellent CLI libraries (Cobra is industry standard)
- Simple cross-compilation for multiple platforms
- Good enough performance (not CPU-bound work)
- Used by similar tools (direnv, gh, etc.)

### Why not a direnv dependency?

- Reduces external dependencies
- More control over shell integration
- direnv users can still use both (they don't conflict)
